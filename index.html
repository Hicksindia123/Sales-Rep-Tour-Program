<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rep Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7fa; padding: 20px; color: #333; }
    h2, h3 { color: #2c3e50; }
    select, button, input[type="text"] { padding: 6px; font-size: 14px; margin: 0 5px 15px 0; min-width: 120px; }
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; overflow-x: auto; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; white-space: nowrap; }
    th { background-color: #3498db; color: white; position: sticky; top: 0; }
    button { background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #27ae60; }
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>Rep Dashboard</h2>
  <div>
    <label>Month:
      <select id="monthFilter" onchange="loadData()">
        <option value="">All</option>
        <option>January</option><option>February</option><option>March</option><option>April</option>
        <option>May</option><option>June</option><option>July</option><option>August</option>
        <option>September</option><option>October</option><option>November</option><option>December</option>
      </select>
    </label>
    <label>Distributor:
      <select id="distributorFilter" onchange="loadData()">
        <option value="">All</option>
      </select>
    </label>
  </div>

  <div class="dashboard">
    <div class="section">
      <h3>Date-wise Visits</h3>
      <div id="visitsContainer"><p>Loading...</p></div>
    </div>
    <div class="section">
      <h3>Distributor Status</h3>
      <div id="distributorContainer"><p>Loading...</p></div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbytWubm7-RVRHwTBFHEoZ2KSlQb7BK1kaI6nj9osM8iQ_doErywSDkpUDfMzLmMQXs2pw/exec';

    function getRepFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("rep") || "";
    }

    async function fetchAPI(params) {
      const formData = new URLSearchParams(params).toString();
      const res = await fetch(API_URL, {
        method: 'POST',
        body: formData,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
      return res.json();
    }

    async function loadData() {
      const repName = getRepFromURL();
      const selectedMonth = document.getElementById("monthFilter").value;
      const selectedDistributor = document.getElementById("distributorFilter").value;

      if (!repName) return;

      // Load Visits
      const visitData = await fetchAPI({ action: 'getRepData', repName });
      let visitHTML = `<table><tr><th>Date</th><th>State</th><th>City</th><th>Visit Status</th><th>Reason If Not Done</th><th>Update</th></tr>`;
      visitData.forEach(row => {
        const [date, , month, , , state, city, status, reason] = row.data;
        if (selectedMonth && month !== selectedMonth) return;
        const rowId = row.row;
        visitHTML += `<tr>
          <td>${date}</td>
          <td>${state}</td>
          <td>${city}</td>
          <td>
            <select id="vs_${rowId}" onchange="toggleReason(${rowId})">
              <option value="">--</option>
              <option value="Done" ${status === "Done" ? "selected" : ""}>Done</option>
              <option value="Not Done" ${status === "Not Done" ? "selected" : ""}>Not Done</option>
            </select>
          </td>
          <td><input type="text" id="reason_${rowId}" value="${reason || ''}" style="${status === 'Not Done' ? '' : 'display:none;'}"></td>
          <td><button onclick="updateVisitStatus(${rowId})">✔</button></td>
        </tr>`;
      });
      visitHTML += `</table>`;
      document.getElementById("visitsContainer").innerHTML = visitHTML;

      // Load Distributors
      const distData = await fetchAPI({ action: 'getRepDistributors', repName, month: selectedMonth });
      const allDistributors = [...new Set(distData.map(d => d.distributor))];
      const distFilter = document.getElementById("distributorFilter");
      distFilter.innerHTML = '<option value="">All</option>' + allDistributors.map(d => `<option value="${d}">${d}</option>`).join('');

      const filtered = distData.filter(d => !selectedDistributor || d.distributor === selectedDistributor);
      let distributorHTML = `<table><tr><th>Distributor</th><th>Month</th><th>Status</th><th>Update</th></tr>`;
      if (filtered.length === 0) {
        distributorHTML += `<tr><td colspan='4'>No distributor data found</td></tr>`;
      } else {
        filtered.forEach(row => {
          distributorHTML += `<tr>
            <td>${row.distributor}</td>
            <td>${row.month}</td>
            <td><select id="status_${row.row}">
              <option value="">--</option>
              <option value="Done">Done</option>
            </select></td>
            <td><button onclick="updateStatus('${repName}', '${row.distributor}', '${row.month}', ${row.row})">✔</button></td>
          </tr>`;
        });
      }
      distributorHTML += `</table>`;
      document.getElementById("distributorContainer").innerHTML = distributorHTML;
    }

    function toggleReason(rowId) {
      const status = document.getElementById(`vs_${rowId}`).value;
      const reasonInput = document.getElementById(`reason_${rowId}`);
      reasonInput.style.display = (status === "Not Done") ? '' : 'none';
    }

    async function updateVisitStatus(rowId) {
      const status = document.getElementById(`vs_${rowId}`).value;
      const reason = document.getElementById(`reason_${rowId}`).value;
      await fetchAPI({
        action: 'updateVisitStatus',
        row: rowId,
        status,
        reason
      });
      alert("Visit updated!");
      loadData();
    }

    async function updateStatus(repName, distributor, month, row) {
      const status = document.getElementById(`status_${row}`).value;
      await fetchAPI({
        action: 'updateStatus',
        repName,
        distributor,
        month,
        status
      });
      alert("Distributor status updated!");
      loadData();
    }

    loadData();
  </script>
</body>
</html>
