<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rep Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7fa; padding: 20px; color: #333; }
    h2, h3 { color: #2c3e50; }
    select, button, input[type="date"] { padding: 6px; font-size: 14px; margin: 0 5px 15px 0; min-width: 120px; }
    .choices__inner { max-width: 200px !important; min-height: 36px; }
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; overflow-x: auto; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; white-space: nowrap; }
    th { background-color: #3498db; color: white; position: sticky; top: 0; }
    button { background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #27ae60; }
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>Rep Dashboard</h2>
  <div>
    <label>Month:
      <select id="monthFilter" onchange="loadData()">
        <option value="">All</option>
        <option value="January">January</option><option value="February">February</option>
        <option value="March">March</option><option value="April">April</option>
        <option value="May">May</option><option value="June">June</option>
        <option value="July">July</option><option value="August">August</option>
        <option value="September">September</option><option value="October">October</option>
        <option value="November">November</option><option value="December">December</option>
      </select>
    </label>
  </div>
  <div class="dashboard">
    <div class="section">
      <h3>Date-wise Visits</h3>
      <div id="visitsContainer"><p>Loading...</p></div>
    </div>
    <div class="section">
      <h3>Distributor Status</h3>
      <div id="distributorContainer"><p>Loading...</p></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxFZ5MFtvgAABwB1wBCm6KBX64VZwplpxla8ajyF605KJLk1v5YPJs2Mjd1SwmBLHmbBg/exec';

    function getRepFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("rep") || "";
    }

    function formatDateOnly(dateStr) {
      const date = new Date(dateStr);
      return isNaN(date) ? dateStr : date.toISOString().split('T')[0];
    }

    async function fetchAPI(params) {
      const formData = new URLSearchParams(params).toString();
      const res = await fetch(API_URL, {
        method: 'POST',
        body: formData,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
      return res.json();
    }

    async function loadData() {
      const repName = getRepFromURL();
      const selectedMonth = document.getElementById("monthFilter").value;
      if (!repName) {
        document.getElementById("visitsContainer").innerHTML = "<p style='color:red;'>Rep not specified in URL.</p>";
        return;
      }
      const data = await fetchAPI({ action: 'getRepData', repName });

      let visitHTML = `<table><tr><th>Date</th><th>State</th><th>City</th></tr>`;
      let distributorHTML = `<table><tr><th>Distributor</th><th>Month</th><th>Status</th><th>Update</th></tr>`;

      const distributorsSet = new Set();

      data.forEach(row => {
        const [date, , month, , , state, city] = row.data;
        if (selectedMonth && month !== selectedMonth) return;

        visitHTML += `<tr><td>${formatDateOnly(date)}</td><td>${state}</td><td>${city}</td></tr>`;

        const distributor = row.data[7] || "";
        const status = row.data[8] || "";

        if (distributor && !distributorsSet.has(distributor)) {
          distributorsSet.add(distributor);
          distributorHTML += `<tr>
            <td>${distributor}</td>
            <td>${month}</td>
            <td><select id="status_${row.row}">
              <option value="">--</option>
              <option value="Done" ${status === "Done" ? "selected" : ""}>Done</option>
            </select></td>
            <td><button onclick="updateStatus('${repName}', '${distributor}', '${month}', ${row.row})">âœ”</button></td>
          </tr>`;
        }
      });

      visitHTML += `</table>`;
      distributorHTML += distributorsSet.size > 0 ? `</table>` : `<tr><td colspan='4'>No data found in Sheet3 for this rep and month</td></tr></table>`;

      document.getElementById("visitsContainer").innerHTML = visitHTML;
      document.getElementById("distributorContainer").innerHTML = distributorHTML;
    }

    async function updateStatus(repName, distributor, month, row) {
      const status = document.getElementById(`status_${row}`).value;
      await fetchAPI({
        action: 'updateStatus',
        repName: repName,
        distributor: distributor,
        month: month,
        status: status
      });
      alert("Status updated!");
      loadData();
    }

    loadData();
  </script>
</body>
</html>
